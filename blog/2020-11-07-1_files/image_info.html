<!DOCTYPE html>
<html>
  <head>
    <script src="/vendor/jquery-3.5.1.slim.min.js"></script>
    <script src="/vendor/preact-10.4.8.min.js"></script>
    <script src="/vendor/htm-3.0.4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
    <script>
      html = htm.bind(preact.h);
      EXIF.enableXmp();
    </script>
  </head>
  <body>
    <script>
      const { Component, render, createRef } = preact;
      function create_UUID() {
        var dt = new Date().getTime();
        var uuid = "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(
          /[xy]/g,
          function (c) {
            var r = (dt + Math.random() * 16) % 16 | 0;
            dt = Math.floor(dt / 16);
            return (c == "x" ? r : (r & 0x3) | 0x8).toString(16);
          }
        );
        return uuid;
      }

      class ImageInfo extends Component {
        constructor(props) {
          super(props);
          this.state = { guid: create_UUID(), xmp: {} };
        }
        componentDidMount() {
          const { guid } = this.state;
          var img1 = document.getElementById(guid);
          const comp = this;
          $(`#${guid}`)
            .one("load", function () {
              EXIF.getData(img1, function () {
                const attrs = this.xmpdata["x:xmpmeta"]["rdf:RDF"][
                  "rdf:Description"
                ]["@attributes"];
                comp.setState({ xmp: attrs });
              });
            })
            .each(function () {
              if (this.complete) $(this).load();
            });
        }
        render({ img }, { guid, xmp }) {
          return html`
            <div style="display: flex">
              <div>
                <img id=${guid} src=${img} />
              </div>
              <div>
                <p>Yaw  : ${xmp['drone-dji:GimbalYawDegree']}</p>
                <p>Pitch: ${xmp['drone-dji:GimbalPitchDegree']}</p>
                </div>
            </div>
          `;
        }
      }
      class App extends Component {
        render() {
          const images = [];
          for (let i = 1; i < 51; i++) {
            images.push(`./images/${i}.jpg`);
          }
          return html`<div>
            ${images.map((i) => html`<${ImageInfo} img=${i} />`)}
          </div>`;
        }
      }
      render(html`<${App} page="All" />`, document.body);
    </script>
  </body>
</html>
