## Setting up microk8s on raspberry pi
This site runs on a Raspberry Pi 4. With 8GB RAM and 4 cores, it should handle kubernetes, including the tiny deployments which I will have, comfortably.

But I also want to automate the blog updates, so lets also setup a CI/CD server.

First the hardware. I got this kit off of amazon.in. Very standard looking kit, and it comes with a 2-speed fan. 2-speed fan means the fan can be wired to either 5V pins or 3.3V pins. Assembling the kit is very straight-forward, if required, youtube has a lot of video walk-throughs.

I used Raspberry's official [Imager](https://www.raspberrypi.org/blog/raspberry-pi-imager-imaging-utility/) utility and prepared a 128GB SD card with ubuntu server 20.04. For headless install, edit `network-config` file in boot partiotion on SD card and add wifi credentials if using wifi. Ubuntu image has ssh enabled by default, initial credentials are ubuntu:ubuntu. On first boot, it prompts to change password. I also added my ssh key and disabled ssh password logins.

About the fan though... I wired it at 5V at first, it was very loud, so I wired it to 3.3V. Its quieter, but there is still a slight hum. Its also constantly running, which will reduce its life. Typically, computer fans have controllers which set fan speed based on current temperature, and they can be turned off if the temperature is not too high. We can do that with this kit too, by connecting fan to a GPIO pin instead of 3.3V, and controlling the pin output with some code. But GPIO pins are not designed to drive loads higher than LEDs usually, so I will order a kit with some suitable resistors and transistors to make a simple circuit. Mote on this later. For now its quiet enough.

## Install microk8s
[Microk8s](https://microk8s.io/) is a batteries-included kubernetes package aimed at developers. Its light enough to run on the Pi and easy to setup.

```bash
sudo apt update
sudo apt upgrade
sudo snap install microk8s --classic
microk8s enable dns storage registry ingress
sudo apt install docker.io 
sudo usermod -aG docker $USER
sudo mkdir -p /etc/docker
sudo cat << EOF > /etc/docker/daemon.json
{
    "insecure-registries" : [ "localhost:32000" ]
}
EOF
```

Thats it! Its done.

Um, not exactly. Sometime microk8s doesn't start after boot. More on that in next post.

Till then, I would like to have some automation system on the pi, which can run things automatically. Popular choices for this are [Jenkins](https://www.jenkins.io/) and [Gitlab CI](https://docs.gitlab.com/ee/ci/). Both of these are huge, gitlab CI more so because it also needs gitlab. So what else is there?

[Buildbot](https://buildbot.net/) is a small automation server written in python. Its also used by many huge and popular projects like chromium, firefox, python...

The downside is that it takes much more fiddling aorund to configure than something like Jenkins. The upside is that all config is in files, so once configured, I can backup the configs and never bother about it again.

I found and followed this guide on installation from digital ocean: https://www.digitalocean.com/community/tutorials/how-to-install-buildbot-on-ubuntu-16-04 . Its for an older ubuntu version but that didn't cause any issues.

I have a lightweight automation system. I made a new private git repo, with a single script which does nothing. Everytime I push to the repo, buildbot will pull the changes and run the script.
