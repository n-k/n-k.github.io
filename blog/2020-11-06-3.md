## Blog site: v1
This post is a continuation of a series on setting up a raspberry pi for this site. In the [previous post](http://localhost:8000/blog/posts/2020-11-06-2.md), we had microk8s installed and running and fixed startup problems.

Lets start making a simple blog site. I don't need anything fancy, just some posts to be shown in reverse chronological order. No comments. But I will need images, and a way to show code and formulae properly. Also, it I can write the posts in markdown and track them in git, that would be great.

There are plenty of popular solutions for this, simplest one is [Docsify](https://docsify.js.org/#/) IMO. But its too limited. I want to write some future posts about computer vision and they will be better with interactive widgets, js and WASM. So, pure markdown based approach is out. I'm going to build my own thing with https://github.com/markedjs/marked. Lets see how that goes.

There will eventually be a server, but I will start with `python3 -m http.server 8000`, an HTML file and some CDN scripts.

```html
<!DOCTYPE html>
<html>
  <head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/preact/10.5.5/preact.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/htm/3.0.4/htm.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script>
      html = htm.bind(preact.h);
    </script>
  </head>
  <body>
    <script>
      const { Component, render } = preact;
      class App extends Component {
        render() {
          return html`<div>Hello world!</div>`;
        }
      }
      render(html`<${App} />`, document.body);
    </script>
  </body>
</html>
```

Nice! We have hello-world! Let's render a markdown blog post now.

I can keep the blog posts in a subdirectory called blogs. And I can list them like I would normally browse through a directory: using the directory listing page. So I'll have a bunch of .md files in ./blog/ , I'll get links to them by parsing the HTML returned from `fetch('./blog/')` and doing some regex'ing on the `a` tags, and do something to render them. For keeping track of when posts were written, I'll use a naming scheme `dddd-mm-yy-{post index wuthin day}.md`.

Yes, this is disgusting according to all "Modern UI" thinking. ¯\\_(ツ)_/¯ I'll be careful, I guess. Its not like there's any user-input or much interaction here. Most importantly, this is a fun/hobby site, not a bank's production site.

Lets get the list of posts:

```javascript
// in App#componentDidMount
fetch("./blog/").then((res) => {
  res.text().then((t) => {
    const dom = $.parseHTML(t);
    const as = $("a", dom)
      .get()
      .map((a) => {
        const split = a.href.split("/");
        return split.length > 0 ? split[split.length - 1] : null;
      })
      .filter((a) => {
        // if it doesn't look like a blog entry don't include it
        const match = a.match(/^((\d{4})-0?(\d+)-0?(\d+)).*$/);
        return match && match.length > 1 && a.endsWith(".md");
      })
      .sort();
    this.setState({ entries: as });
  });
});
```

This works because http.server module has directory listings enabled by default, when I get to building the server, I can have an API to list blogs, but I like the idea of also being able to work on the UI without a server, so maybe that API could be text/html.

For converting the markdown content to HTML, `marked` is very handy. The whole single file app now looks like:

```html
<!DOCTYPE html>
<html>
  <head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/preact/10.5.5/preact.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/htm/3.0.4/htm.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/1.2.3/marked.min.js"></script>
    <script>
      html = htm.bind(preact.h);
    </script>
  </head>
  <body>
    <script>
      const { Component, render, createRef } = preact;
      class App extends Component {
        componentDidMount() {
          fetch("./blog/").then((res) => {
            res.text().then((t) => {
              const dom = $.parseHTML(t);
              const as = $("a", dom)
                .get()
                .map((a) => {
                  const split = a.href.split("/");
                  return split.length > 0 ? split[split.length - 1] : null;
                })
                .filter((a) => {
                  // if it doesn't look like a blog entry don't include it
                  const match = a.match(/^((\d{4})-0?(\d+)-0?(\d+)).*$/);
                  return match && match.length > 1 && a.endsWith(".md");
                })
                .sort();
              this.setState({ entries: as });
            });
          });
        }
        render() {
          const { entries } = this.state;
          return html`<div>
            ${(entries || []).map((id) => html`<${MarkdownFile} id=${id} />`)}
          </div>`;
        }
      }

      class MarkdownFile extends Component {
        divRef = createRef();
        componentDidMount() {
          const { id } = this.props;
          fetch(`/blog/${id}`).then((res) => {
            res.text().then((t) => {
              if (this.divRef.current) {
                this.divRef.current.innerHTML = marked(t);
              }
            });
          });
        }
        render() {
          return html`<div ref=${this.divRef} />`;
        }
      }

      render(html`<${App} />`, document.body);
    </script>
  </body>
</html>
```

Just adding a stylesheet will make this into something I could call a "blog".
